name: "ALKiln/github_server: Isolated docassemble tests"
description: "Download and start up a temporary docassemble server on GitHub's servers, in an isolated environment. Avoids docassemble reload errors and other external factors."


inputs:
  CONFIG_CONTENTS:
    description: "The contents of the config file of the docassemble server"
    required: false
  MAX_SECONDS_FOR_DOCKER:
    description: "Maximum amount of seconds to give the docassemble docker container to serve the site."
    required: false
    default: 600  # 10 min

outputs:
  DOCASSEMBLE_DEVELOPER_API_KEY:
    description: "Use this inside `with:` for the ALKiln step. Temporary admin api key. It will be destroyed after the tests are done."
    value: ${{ steps.api_key_output_step.outputs.DOCASSEMBLE_DEVELOPER_API_KEY }}
  SERVER_URL:
    description: "Use this inside `with:` for the ALKiln step. URL of the temporary docassemble server."
    value: "http://localhost"


runs:
  using: "composite"
  steps:
      - name: "github_server: Set environment variables"
        run: |
          echo "DA_ADMIN_API_KEY=abcd1234abcd1234abcd5678abdc5678" >> $GITHUB_ENV
        shell: bash
      - id: api_key_output_step
        run: echo "::set-output name=DOCASSEMBLE_DEVELOPER_API_KEY::$DA_ADMIN_API_KEY"
        shell: bash
      - name: "github_server: Download and start docker"
        run: |
          mkdir /tmp/config
          echo "${{ inputs.CONFIG_CONTENTS }}" > /tmp/config/myconfig.yml 
          docker pull jhpyle/docassemble
          docker run --env DA_ADMIN_EMAIL="admin@example.com" --env DA_ADMIN_PASSWORD="password" --env DA_ADMIN_API_KEY="${{ env.DA_ADMIN_API_KEY }}" --env DA_CONFIG=/tmp/config/myconfig.yml --volume /tmp/config:/tmp/config --cap-add SYS_PTRACE --memory="4gb" -d -p 80:80 jhpyle/docassemble
        shell: bash
      - name: "github_server: Wait for server to start"
        run: |
          # github_server: Wait for server to start

          # Wait 1 minute before pinging the server constantly
          sleep 60

          # Use a variable we can control to avoid race conditions from
          # preventing the success log message.
          ready="false"
          # Reset the SECONDS variable
          SECONDS=60

          while [[ $ready == "false" ]]; do
            echo "Time ellapsed: $SECONDS seconds"

            # Get input for max number of seconds to wait
            # ${{ inputs.MAX_SECONDS_FOR_DOCKER }} as a number? Bash doesn't have types, just strings
            # Check if max seconds till loading has passed
            if [[ $SECONDS -ge 600 ]]; then
              echo "Error: Timed out waiting for docker container to serve the site."
              break
            fi

            # Set the variable to a new string value in each iteration
            result=$(curl -s localhost)

            # Check if the string includes the desired text
            if [[ ! $result == *"Docassemble is starting"* ]]; then
              echo "Success! The docker container is ready!"
              ready="true"
            else
              echo "The docker container isn't ready yet. Will check again in 30 seconds."
              sleep 30
            fi

          done
        shell: bash
      - name: Docker logs
        if: ${{ always() }}
        # TODO: create an arifact for this instead
        run: |
          docker logs $(docker ps --filter "ancestor=jhpyle/docassemble" --format {{.ID}})
        shell: bash
