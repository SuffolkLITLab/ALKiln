name: GitHub server tests

on:
  push:
  # why is workflow dispatch not showing up in github?
  workflow_dispatch:
    inputs:
      tags:
        required: False
        description: 'Optional. Use a "tag expression" specify which tagged tests to run (https://cucumber.io/docs/cucumber/api/#tag-expressions)'
        # Only test 2 tests - one uses an env var, the other uses AL.
        # They test if env vars get set correctly and depencencies get
        # pulled in correctly.
        default: '@e6 or @al1'
      enable_tmate:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: true
      # TODO: alkiln_version:

jobs:

  github-server-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]

    env:
      USER1_EMAIL: admin@example.com
      USER1_PASSWORD: password
      SECRET_VAR1: secret-var1-value
      SECRET_VAR2: secret-var2-value
      SECRET_FOR_MISSING_FIELD: secret for missing field
      
    steps:
      - uses: actions/checkout@v3
      - name: Setup tmate session
        if: ${{ inputs.enable_tmate }}
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
          
      - name: Start the temporary GitHub server
        id: github_server
        uses: ./github_server
        with:
          CONFIG_CONTENTS: "${{ secrets.CONFIG_CONTENTS }}"
      - run: echo "Finished starting the GitHub server"

      - name: "Run ALKiln tests"
        if: ${{ success() }}
        uses: ./
        with:
          SERVER_URL: "${{ steps.github_server.outputs.SERVER_URL }}"
          DOCASSEMBLE_DEVELOPER_API_KEY: "${{ steps.github_server.outputs.DOCASSEMBLE_DEVELOPER_API_KEY }}"
          INSTALL_METHOD: "server"
          ALKILN_VERSION: "5.0.2-feat-github-server-1"
      - run: echo "Finished running ALKiln tests"

