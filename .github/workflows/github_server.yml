name: GitHub server tests

on:
  push:
  workflow_dispatch:
    inputs:
      tags:
        required: False
        description: 'Optional. Use a "tag expression" specify which tagged tests to run (https://cucumber.io/docs/cucumber/api/#tag-expressions)'
        # Only test 2 tests - one uses an env var, the other uses AL.
        # They test if env vars get set correctly and depencencies get
        # pulled in correctly.
        default: '@e6 or @al1'
      console_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: true

jobs:

  github-server-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]

    env:
      USER1_EMAIL: ${{ secrets.USER1_EMAIL }}
      USER1_PASSWORD: ${{ secrets.USER1_PASSWORD }}
      SECRET_VAR1: secret-var1-value
      SECRET_VAR2: secret-var2-value
      SECRET_FOR_MISSING_FIELD: secret for missing field
      
    steps:
      - uses: actions/checkout@v3
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
        #if: ${{ inputs.console_enabled }}
        #with:
        #  sudo: false
      - name: Start the temporary GitHub server
        id: github_server
        uses: SuffolkLITLab/ALKiln/github_server@start_server_workflow
        with:
          CONFIG_CONTENTS: "${{ secrets.CONFIG_CONTENTS }}"
          #ALKILN_VERSION: 5.0.2-feat-github-server-1
      - name: Print GitHub server vars
        run: |
          echo "key ${{ steps.github_server.outputs.DOCASSEMBLE_DEVELOPER_API_KEY }}"
          echo "url ${{ steps.github_server.outputs.SERVER_URL }}"
      - run: echo "Finished starting the GitHub server"
